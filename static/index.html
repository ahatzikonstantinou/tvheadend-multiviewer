<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>TV Mosaic Settings</title>
  <link rel="stylesheet" href="/static/css/main.css">
  <!-- <link rel="stylesheet" href="/static/css/common.css"> -->
</head>
<body>
  <header class="main-header"> 
    <div class="left-controls">
      <h1>TV Mosaic Settings</h1>
    </div>
    <button id="goToChannels" class="cog-btn">ðŸ“º</button> 
  </header>

  <div>
    <label>
      TVHeadend URL:
      <input type="text" id="tvh-url" size="40" placeholder="http://192.168.3.104:9981">
    </label>

    <br>

    <label>
      Username:
      <input type="text" id="tvh-username" size="20" placeholder="admin">
    </label>

    <br>

    <label>
      Password:
      <input type="password" id="tvh-password" size="20" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
    </label>

    <br>

    <button id="btn-test">Test connection</button>
    <span id="test-result"></span>

    <br>

    <button id="btn-load-channels">Load channels</button>
    <span id="channels-status"></span>

    <br>
    <button id="btn-save">Save settings</button>
    <span id="save-status"></span>

  </div>

  <h2>Grids</h2>

  <table id="gridTable" border="1" cellspacing="0" cellpadding="6">
    <thead>
      <tr>
        <th data-sort="name">Name</th>
        <th data-sort="rows">Rows</th>
        <th data-sort="cols">Cols</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <h3>Create / Edit Grid</h3>

  <input type="hidden" id="grid-uuid">

  <label>
    Grid name:
    <input type="text" id="grid-name">
  </label>

  <label>
    Rows:
    <input type="number" id="grid-rows" min="1" max="10">
  </label>

  <label>
    Cols:
    <input type="number" id="grid-cols" min="1" max="10">
  </label>

  <button id="btn-new-grid">New Grid</button>

  <br>

  <div id="grid-container"></div>

  <button id="btn-save-grid">Save Grid</button>
  <hr>

  <script>
    let channels = [];
    let cells = []; // {row, col, channel_uuid}

    document.getElementById("goToChannels").addEventListener("click", () => {
      window.location.href = "/grid2";
    });

    async function loadSettings() {
      const res = await fetch('/api/settings');
      const cfg = await res.json();
      document.getElementById('tvh-url').value = cfg.tvheadend_url || '';
      document.getElementById("tvh-username").value = cfg.tvh_username || ""; 
      document.getElementById("tvh-password").value = cfg.tvh_password || "";
      cells = cfg.cells || [];
      
      renderGrid();
    }

    function renderGrid() {
      const rows = parseInt(document.getElementById('grid-rows').value, 10);
      const cols = parseInt(document.getElementById('grid-cols').value, 10);
      const container = document.getElementById('grid-container');
      container.innerHTML = '';

      for (let r = 0; r < rows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'grid-row';
        for (let c = 0; c < cols; c++) {
          const cellDiv = document.createElement('div');
          cellDiv.className = 'grid-cell';

          const label = document.createElement('div');
          label.textContent = `Cell ${r},${c}`;
          cellDiv.appendChild(label);

          const select = document.createElement('select');
          select.dataset.row = r;
          select.dataset.col = c;

          const optNone = document.createElement('option');
          optNone.value = '';
          optNone.textContent = '-- none --';
          select.appendChild(optNone);

          channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.uuid;
            opt.textContent = `${ch.number || ''} ${ch.name}`;
            select.appendChild(opt);
          });

          const existing = cells.find(
            ce => ce.row === r && ce.col === c
          );
          if (existing && existing.channel_uuid) {
            select.value = existing.channel_uuid;
          }

          select.addEventListener('change', () => {
            const row = parseInt(select.dataset.row, 10);
            const col = parseInt(select.dataset.col, 10);
            const uuid = select.value || null;
            const idx = cells.findIndex(ce => ce.row === row && ce.col === col);
            if (idx >= 0) {
              cells[idx].channel_uuid = uuid;
            } else {
              cells.push({ row, col, channel_uuid: uuid });
            }
          });

          cellDiv.appendChild(select);
          rowDiv.appendChild(cellDiv);
        }
        container.appendChild(rowDiv);
      }
    }

    document.getElementById('grid-rows').addEventListener('change', renderGrid);
    document.getElementById('grid-cols').addEventListener('change', renderGrid);

    document.getElementById('btn-test').addEventListener('click', async () => {
      const url = document.getElementById('tvh-url').value;
      const resSpan = document.getElementById('test-result');
      resSpan.textContent = 'Testing...';
      const res = await fetch('/api/test_connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
          tvheadend_url: document.getElementById("tvh-url").value,
          tvh_username: document.getElementById("tvh-username").value,
          tvh_password: document.getElementById("tvh-password").value
        })
      });
      const j = await res.json();
      if (j.ok) {
        resSpan.textContent = 'OK';
      } else {
        resSpan.textContent = 'Error: ' + (j.error || 'unknown');
      }
    });

    async function loadChannels(){
      const url = document.getElementById('tvh-url').value;
      const username = document.getElementById('tvh-username').value; 
      const password = document.getElementById('tvh-password').value;
      const status = document.getElementById('channels-status');
      console.log('url, username, password:', url, username, password);
      status.textContent = 'Loading...';
      const res = await fetch('/api/channels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tvheadend_url: url, tvh_username: username, tvh_password: password })
      });
      const j = await res.json();
      if (j.ok) {
        channels = j.channels;
        status.textContent = `Loaded ${channels.length} channels`;
        renderGrid();
      } else {
        status.textContent = 'Error: ' + (j.error || 'unknown');
      }
    }
    document.getElementById('btn-load-channels').addEventListener('click',loadChannels);

    document.getElementById('btn-save').addEventListener('click', async () => {
      const status = document.getElementById('save-status');
      status.textContent = 'Saving...';
      const body = {
        tvheadend_url: document.getElementById('tvh-url').value,
        tvh_username: document.getElementById("tvh-username").value,
        tvh_password: document.getElementById("tvh-password").value,
        grids: grids
      };
      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await res.json();
      status.textContent = j.status === 'ok' ? 'Saved' : 'Error saving';
    });

    loadSettings();

    let grids = [];   // full grid objects

    // -----------------------------
    // Load all settings including grids
    // -----------------------------
    async function loadSettings() {
      const res = await fetch('/api/settings');
      const cfg = await res.json();

      document.getElementById('tvh-url').value = cfg.tvheadend_url || '';
      document.getElementById("tvh-username").value = cfg.tvh_username || ""; 
      document.getElementById("tvh-password").value = cfg.tvh_password || "";

      grids = cfg.grids || [];
      renderGridTable();
    }

    // -----------------------------
    // Render sortable grid table
    // -----------------------------
    function renderGridTable(sortKey = "name", asc = true) {
      const tbody = document.querySelector("#gridTable tbody");
      tbody.innerHTML = "";

      const sorted = [...grids].sort((a, b) => {
        if (a[sortKey] < b[sortKey]) return asc ? -1 : 1;
        if (a[sortKey] > b[sortKey]) return asc ? 1 : -1;
        return 0;
      });

      sorted.forEach(grid => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${grid.name}</td>
          <td>${grid.rows}</td>
          <td>${grid.cols}</td>
          <td>
            <button data-uuid="${grid.uuid}" class="edit-btn">Edit</button>
            <button data-uuid="${grid.uuid}" class="delete-btn">Delete</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          loadGridIntoForm(btn.dataset.uuid);
        });
      });
    }

    // -----------------------------
    // Load grid into form for editing
    // -----------------------------
    function loadGridIntoForm(uuid) {
      const g = grids.find(x => x.uuid === uuid);
      if (!g) return;

      document.getElementById("grid-uuid").value = g.uuid;
      document.getElementById("grid-name").value = g.name;
      document.getElementById("grid-rows").value = g.rows;
      document.getElementById("grid-cols").value = g.cols;

      cells = g.cells || [];
      renderGrid();
    }

    // -----------------------------
    // Create new grid (clear form)
    // -----------------------------
    document.getElementById("btn-new-grid").addEventListener("click", () => {
      document.getElementById("grid-uuid").value = "";
      document.getElementById("grid-name").value = "";
      document.getElementById("grid-rows").value = 3;
      document.getElementById("grid-cols").value = 4;
      cells = [];
      renderGrid();
    });

    // -----------------------------
    // Save grid (create or update)
    // -----------------------------
    document.getElementById("btn-save-grid").addEventListener("click", async () => {
      const uuid = document.getElementById("grid-uuid").value;
      const name = document.getElementById("grid-name").value.trim();
      const rows = parseInt(document.getElementById("grid-rows").value);
      const cols = parseInt(document.getElementById("grid-cols").value);

      if (!name) {
        alert("Grid name required");
        return;
      }

      // enforce unique name
      if (grids.some(g => g.name === name && g.uuid !== uuid)) {
        alert("Grid name must be unique");
        return;
      }

      let grid;

      if (uuid) {
        // update existing
        grid = grids.find(g => g.uuid === uuid);
        grid.name = name;
        grid.rows = rows;
        grid.cols = cols;
        grid.cells = cells;
      } else {
        // create new
        grid = {
          uuid,
          name,
          rows,
          cols,
          cells
        };
        grids.push(grid);
      }

      await saveAllSettings();
      renderGridTable();
    });

    // -----------------------------
    // Delete grid
    // -----------------------------
    document.querySelector("#gridTable").addEventListener("click", async (e) => {
      if (!e.target.classList.contains("delete-btn")) return;

      const uuid = e.target.dataset.uuid;
      console.log("Deleting " + uuid);

      if (!confirm("Delete this grid?")) return;

      grids = grids.filter(g => g.uuid !== uuid);
      await saveAllSettings();
      renderGridTable();

      const current = document.getElementById("grid-uuid").value;
      if (current === uuid) {
        document.getElementById("btn-new-grid").click();
      }
    });


    // -----------------------------
    // Save everything to backend
    // -----------------------------
    async function saveAllSettings() {
      const status = document.getElementById('save-status');
      status.textContent = 'Saving...';
      const body = {
        tvheadend_url: document.getElementById('tvh-url').value,
        tvh_username: document.getElementById("tvh-username").value,
        tvh_password: document.getElementById("tvh-password").value,
        grids: grids
      };

      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await res.json();
      if (j.status === 'ok') {
        status.textContent = 'Saved';
      } else {
        status.textContent = 'Error saving';
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadSettings();
      await loadChannels();
    });


  </script>
</body>
</html>
